---
title: ComputerVisionAndAugmentedRealityActiveCV
description: 
published: true
date: 2024-01-25T13:43:02.038Z
tags: 
editor: markdown
dateCreated: 2024-01-25T07:43:17.515Z
---

# Компьютерное зрение и дополненная реальность ActiveCV
## Режим дополненной реальности ActiveCV
В систему добавлены самостоятельные объекты, которые совмещают различные AI-детекоры с визуализацией в видеопотоке и взаимодействие с обработчиками Python по событиям, которые происходят в видеопотоке. Таким образом в режиме камеры происходит вывод информации в графической форме и сканирование объектов различными детекторами - это создает эффект дополненной реальности. Этот режим может дополнять существующий традиционный интерфейс или полностью заменить его. Например в кадре можно вывести информацию по объекту или подкрашивать разными цветами объекты которые нужно учитывать или которые уже учтены (например если по товару уже проведена инвентаризация то он может быть окрашен желтым цветом, а ненужный товар - красным)

Операция может быть добавлена в основное меню конфигурации и запускаться самостоятельно. Либо она может быть вызвана из обычного процесса с помощью команды **«RunCV»** , в значении - название операции. Например `hashMap.put("RunCV", "Просто сканирование всего")`
После закрытия операции любым способом она порождает событие **«onResult»** и передает в пул переменных переменные cv_detected и cv_drawn со списками отсканированных и подсвеченных на экране объектов. Также передаются все остальные текущие переменные процесса. Например current_object - текущий распознанный объект. В сочетании с командой FinishProcess может работать как вызываемый (старый) режим распознавания: запустили RunCV-распознали-закрыли FinishProcess-получили результат.

Вся логика визуализации и распознавания находится в CV-Шаге. Тут же задаются и обработчики всех событий.

Тут задается (для каждого шага):
 - тип детектора - детекторы подробно описаны ниже
 - режим отображения объектов. Логика отображения управляется списками - зеленый, красный, серый, желтый список + невидимые объекты. Списки задаются через специальные переменные при запуске либо по ходу действия. В этом свойстве выбирается вариант отображения.     
 - разрешение - один из 4х вариантов - от 360*240 до FullHD. Разрешение влияет на производительность и FPS - т.е. на плавность работы и нагрузку на процессор.     
 - Настройки распознавания - для детекторов OCR
 - Кнопки действия под экраном - горизонтальный список кнопок, разделенный «;». Можно не задавать кнопки вообще.     
 - Заголовок действия - текст или переменная (через @) в которой задается текст сверху экрана (обязательный)   
 - Инфо - текст или переменная (через @) в которой задается текст внизу экрана (необязательный)     

Виды событий и обработчиков:

 - **OnCreate** При открытии - вызывается при запуске каждого **шага**. Т.е. при переключении шагов будет выполняться этот обработчик. При запуске операции вызывается обработчик первого шага.
- **OnObjectDetected** Найден новый объект - вызывается когда в камеру попал новый объект один раз (т.е. последующие попадания этого объекта не будут восприниматься). Новый объект помещается в переменную **current_object**     
 - **OnTouch** Нажатие на объект - вызывается при таче на объект. Нажатый объект попадает в переменную **touched_object**     
 - **OnInput** Обработка действия - сюда попадают нажатие кнопок под экраном и события диалога     

Входные переменные, задающие отображение объектов:

 - Списки по цветам: **green_list**, **red_list**, **yellow_list**, **gray_list**,**blue_list**, **hidden_list**. Разделитель - «;». Значения - текстовый идентификатор или штрихкод. При наведении объект будет окрашен в выбранный цвет.
  ```python
  green_list = ['740617303506']  
  hashMap.put("green_list", ';'.join(green_list))
  ```
<details>
<summary>Фото пример</summary>
<br>
<img src="/files/Pastedimage20240123174234.png">
</details>

  
 - **object_info_list** - список информации к объектам(доступен html) - нижний. JSON-массив типа 
 ```python
json_list = [{"object": "740617303506",  
              "info": "Датчик температуры белый"}]  
hashMap.put("object_info_list", json.dumps(json_list, ensure_ascii=False))
 ```
<details>
<summary>Фото пример</summary>
<br>
<img src="/files/Pastedimage20240123174934.png">
</details>

- **object_caption_list** - cписок информации к объектам (доступен html в Мультисканер) – в заголовке:  - JSON-массив типа
```python
json_list = [{"object": "740617303506",  
              "caption": "Датчик температуры белый"}]  
hashMap.put("object_caption_list", json.dumps(json_list, ensure_ascii=False))
```
<details>
<summary>Фото пример</summary>
<br>
<img src="/files/Pastedimage20240123175650.png">
</details>

- stop_listener_list - список пропуска обработки объектов (отключает обработчики новых объектов): , разделитель – “;”    
 
Команды, доступные в режиме ActiveCV:

- Все, стандартные команды без контекста - toast, beep и т.д.    
- **NextStep** - переключить на следующий шаг. Указывается имя шага  
- **FinishProcecc** - переключить на следующий шаг  
- **ShowDialog** - полностью аналогично этой же команде в обычных экранах, за исключением того, что в случае размещения на диалоге контейнера с элементами следует указать процесс через **ShowDialogProcess** 
- **remove_drawn** - убирает объект из списка «новых объектов», таким образом если на него еще раз навести то будет снова сгенерировано событие «Новый объект».

## Настройки OCR
Настройки распознавания (поле VisionSettings) можно задавать в конструкторе и также можно задать настройки из кода перед началом распознавания (для экранов и ActiveCV) с помощью команды-переменной:

**SetVisionSettings{словарь с настройками}** – команда для экранов и ActiveCV которая, если ее выполнить до запуска распознавания, задаст настройки детектора

Доступны следующие настройки:

Для варианта «опорная выборка – SQL»:
 - **query** - SQL запрос для варианта поиска по SQL-таблице с одним параметром(в который передается распознанный текст ) Например: 
	```SQL
	SELECT * FROM SW_Goods WHERE product_number LIKE ?  	 
	``` 
 - **control_field** - поле таблицы по которому проверяется OCR , условно Артикул (несмотря на то, что в query оно скорее всего также участвует)>     
 - массив **cursor** с объектами 
	```JSON
	{"field": "поле таблицы",
	 "var": "переменная результат"}
	```
     

Для варианта «опорная выборка – список значений/обработчик":
 - **values_list** (строка) - режим поиска по списку, либо обработчиком. В случае, если опорная выборка – список значений, то он передается строкой с разделителями «;» . Если на событие распознавания текста нужно назначить обработчик, в который передастся весь распознанный текст, то в этот параметр передается строка вида ~<массив обработчиков> . В обработчик попадает распознанный текст в переменную ocr_text. В случае успешного распознавания необходимо поместить что то в переменную ocr_res. Этот вариант только для «Распознавание текста» на экранах, для ActiveCV есть подобное - Мультисканер  

Настройки параметров фильтрации:

 - **min_length** (число) - минимальная длина текста     
 - **max_length** (число) - максимальная длина текста
 - **ReplaceO** (булево) - заменить буквы О на 0 (нули)     
 - **ToUpcase** (булево) - преобразование в верхний регистр  
 - **mesure_qty** (число) - количество измерений (по умолчанию 1 и частота не анализируется)     
 - **min_freq** (число) - число от 0 до 100 - вероятность (в процентах для удобства ввода)     
 - **OnlyNumbers** (булево) - только для Мультисканер - фильтрация только тех объектов, которые - числа     

Специальные режимы:

 - **PlateNumberRecognition** (булево) – режим распознавания автомобильных номеров российские номера (только для ActiveCV)     
 - **NumberRecognition** (булево) - распознавание чисел    
 - **DateRecognition** (булево) - распознавание дат
 - **result_field** (строка) - для распознавания дат и номеров, туда помещается результаты особым образом (смотря что ищем)     
 - **count_objects** (число) – только для NumberRecognition количество циклов измерений. Чем больше циклов тем больше точность

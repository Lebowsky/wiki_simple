---
title: WorkingWithEquipment
description: 
published: true
date: 2024-02-05T07:06:34.734Z
tags: 
editor: markdown
dateCreated: 2024-01-25T07:44:17.960Z
---

# Работа со сканерами штрихкода через стандартные настройки
## Работа со сканерами ТСД
### Подключение через подписку на событие (рекомендовано)
Производители ТСД поставляют на своих устройствах ПО, работающее как сервис, которое раздает сообщения(intent) при сканировании штрихкода. В настройках ТСД это может называться Intent broadcast или что то подобное со словом “Intent”. Для того, чтобы SimpleUI мог принимать такие сообщения в настройках следует активировать «Использовать подписку на события сканера», заполнить поля «Сообщение сканера», «Переменная сканера» и, в некоторых случаях, «Длина значения»(для случаев когда штрихкод передается не в виде строки а в виде байт-массива и отдельно передается длина значения. Эту информацию можно почерпнуть как правила из документации или примеров. Этот способ подключения является рекомендованным, т.к. в отличии от различных подключений через эмуляцию клавиатуры этот способ не перехватывает поля ввода на экране.

### Подключение через различные виды эмуляции клавиатуры
По умолчанию, если сканер настроен выдавать свой результат через эмуляцию клавиатуры и если в конце штрихкода имеется один из вариантов суффикса разделителя строк (например CR, CR/LF ) то подобный ввод воспринимается как штрихкод – т.е. будет сгенерировано событие штрихкода. В случае настроек вывода штрихкода именно как генерации нажатия клавиш друг за другом (обычно в настройках это называется со словом wedge) следует включить галочку Wedge as keys.

## Работа с внешними сканерами штрихкода Bluetooth через настройки
Можно подключать Bluetooth- сканеры в режиме прямого сопряжения (не через эмуляцию клавиатуры, а через чтение событий сканера напрямую). Это более эффективный путь чем через различные виды эмуляции клавиатуры.
Для подобного сопряжения нужно в настройках поставить галочку “Иcпользовать Bluetooth”, выбрать в выпадающем списке Bluetooth устройство и указать суффикс штрихкода (13 по умолчанию)

# Работа с Bluetooth устройствами
В общем случае, для различных категорий Bluetooth устройств схема работы состоит из:

1. Чтение подключенных устройств с целью выбора устройства. Необязательный шаг, если вам известен mac-адрес устройства. На данном шаге могут анализироваться как уже сопряженные устройства так и обнаружение новых
2. Отправка данных на порт устройства – в виде байт-массива.
3. Подписка на данные, получаемые из устройства

Команды для работы с Bluetooth доступны через импорт java-модуля SimpleBluetooth из python-обработчиков и частично через команды-переменные.
Методы и команды доступные из процессов для выбора устройств:
- **BTGetBounded** – команда-переменная для поиска сопряжённых устройств. Получает ответ в переменной **BTResult** в виде JSON-массива подключенных устройств.
- **BTStartScan** – команда-переменная для запуска сканирования новых устройств (помимо уже сопряжённых). По окончанию, возвращает результат в **BTDiscoverResult** в виде JSON-массива устройств. Также совместно с этой командой имеет смысл использовать команду **BTDiscoverHandlers** в качестве параметра к которой указывается стандартный массив обработчиков. Это событие будет сгенерировано по окончанию поиска устройств.

## Подключение к устройству в режиме аксессуара (пассивный режим устройства, например принтер)

Подключение к устройству (mac-выбранный из списка устройств mac-адрес устройства,handlers – строка с обработчиками в случае неудачи)

```python
from ru.travelfood.simple_ui import SimpleBluetooth as BT

bt = BT()
device = bt.get_device(mac) #получение устройства по mac-адресу
if device == None:
   hashMap.put("toast", "Не получилось подключиться")
else:
   if bt.connect_to_client(device,handlers): #подключение к устройству
              #действия с устройством
              bt.close_socket() #отключение от устройства
```

## Подключение к устройству в режиме хоста (активный режим, например сканер)

```python
from ru.travelfood.simple_ui import SimpleBluetooth as BT

bt = BT()
device = bt.get_device(mac)
      if device == None:
          hashMap.put("toast", "Не получилось подключиться")
      else:
          if bt.connect_to_server(device):
              #действия с устройством
```

## Отправка данных (методы модуля SimpleBluetooth)

**write_data("данные", "строка-массив обработчиков")**
Данные – данные в виде строки, целого числа или массива байтов.
Массив обработчиков – строка с обработчиками в случае неудачи

## Подписка на данные устройства, отключение подписки (методы модуля SimpleBluetooth)

**begin_listen_for_data("строка-массив обработчиков")** – подключает массив обработчиков на события устройства. Обработчики должны быть обязательно pythonbytes
**stop_listen()** – отключение подписки на события устройства

# Подключение к устройству через TCP_IP (только отправка)
Возможно только из python-обработчика. Работа заключается в вызове Java-функции `write_socket(String host,int port, String message,String charset)` из модуля SimpleUtilites:
```python
from ru.travelfood.simple_ui import SimpleUtilites as su
su.write_socket(IP, port, data, handlers)
```
- IP, port – IP-адрес и порт (9100 по умолчанию) принтера
- data – либо байт-массив либо строка(UTF-8) данных
- handlers – строка-массив обработчиков в случае неудачи

Функция возвращает `True` в случае успешной отправки и `False` – во всех остальных случаях

# Подключение к устройству через USB (только отправка)
Подключение осуществляется из модуля SimpleUSB. Сканируются подключенные в текущий момент устройства и возвращается первое из списка либо первый принтер из списка подключенных.

Подключение и отправка данных на любое устройство осуществляется командой **write_usb(data, handlers)** (data – строка или массив байтов, handlers – обработчики в случае неудачи):
```python
from ru.travelfood.simple_ui import SimpleUSB as usbClass

usb = usbClass()
usb.write_usb(data, handlers)
```

Подключение к принтеру через USB осуществляется аналогичной командой **print_usb(data, handlers)**
```Python
from ru.travelfood.simple_ui import SimpleUSB as usbClass

usb = usbClass()
usb.print_usb(data, handlers)
```

# Расширенное взаимодействие с SDK некоторых устройств(Urovo, Meferi)
Для устройств некоторых производителей в SimpleUI интегрирована поддержка Android-SDK этих производителей, которая дает дополнительные функции. Например, для ТСД это может быть, помимо просто сканирования штрихкода, возможность включать и выключать сканер программно, блокировать сканер, получать дополнительную информацию в приложении. Не все производители реализуют подобный SDK

## ТСД Urovo

Функции для Urovo реализованы в модуле SimpleUtilites 
`from ru.travelfood.simple_ui import SimpleUtilites`

- **urovo_set_lock_trigger("статус")** - блокировка/разблокировка сканера(если заблокирован, то заблокирована кнопка сканирования). Статус – истина(заблокировано), ложь (разблокировано)
- ** urovo_open_scanner()** - открыть объект сканера (не запускает сканирование, а просто инициализирует сканер и проверяет доступность) . Эта функция должна предшествовать urovo_start_decode
- **urovo_start_decode()** - включает сканер в режим сканирования
- **urovo_stop_decode()** - выключает режим сканирования
- **urovo_close_scanner()**-  завершает работу со сканером
- **urovo_get_scanner_state()** - возвращает текущее состояние сканера
- **urovo_get_lock_trigger_state()** - возвращает текущее состояние блокировки сканера

## ТСД Meferi
ТСД Meferi имеет свое Андроид-SDK которое позволяет управлять состоянием сканера и настройками ТСД в целом. В SimpleUI включен сам SDK и он отдается разработчику в виде объектов класса
```python
from ru.travelfood.simple_ui import Meferi as Meferi
#получение объекта класса ScanManager
manager = Meferi().getScanManager()
#далее работа с объектом, утилизация методов
manager.setScanEnable(True)
manager.keyScan(True)
```

---
title: WorkManager
description: 
published: true
date: 2024-02-13T08:43:27.185Z
tags: 
editor: markdown
dateCreated: 2024-02-13T08:04:15.781Z
---

Преимущества использования WorkManager:
- Задачи будут выполняться даже в случае, если приложение неактивно или отключено.
- Даже после перезагрузки устройства без ограничения по времени. 
- Мы можем установить условия выполнения задачи, например, когда устройство находится на зарядке или имеется интернет-соединение.
-  Периодические задачи будут выполняться по расписанию независимо от обстоятельств.

Когда мы создаем воркер, мы передаем задачу Андроиду, а дальнейшая судьба этой задачи зависит от операционной системы. Нет необходимости в мониторинге выполнения задачи, так как это обязанность операционной системы. ОС также контролирует условия выполнения задачи, такие как доступ к Интернету. Если условие выполнения не выполнено, задача не будет запущена, но как только условие будет выполнено, система автоматически начнет выполнение задачи. В то же время, Simple продолжает свою работу независимо.

## Реализация WorkManager
## Как это реализовано в Simple?

## Однократные фоновые задания

  
Для запуска используется команда -переменная "**StartWork**",  в качестве параметра которой передается json с обработчиками, которые надо выполнить, и тегом задачи. Тег нужен для того, чтобы в случае чего по нему можно было обратиться и отменить выполнение:


```Python
hashMap.put(StartWork, {"work": "массив обработчиков",
						"tag": "тег задачи",
						"retry": "флаг повтора",
						"conditions": "список условий"})
```
- work - унифицированный массив обработчиков, `[{"action":"run","type":"python","method":"some_longtime_routine"}]`
- tag - нужен для того, чтобы в случае чего по нему можно было обратиться и отменить выполнение.
- retry - заставляет в случае неудачи выполнения (исключение в коде или ошибка http-запроса >200), переключаться в состояние RETRY, что ставит задачу снова в очередь выполнения. 
- conditions - условия, например: `"BATTERY_NOT_LOW;CHARGING;CONNECTED"`

Выполнение Python и выполнение некоторых команд зависит от контекста приложения, т.е. например, чтобы выполнить ShowScreen, нужно, чтобы было хотя бы в свернутом виде запущено приложение Simple и открыт какой то процесс в нем. Для speak нужен просто контекст приложения, чтобы был запущен TTS – менеджер. То есть, другими словами, некоторые команды не выполнятся, если приложение вообще не запущено или находится в сне. Но есть команды, которые будут выполнены даже если девайс перезапущен и в памяти не висит SimpleUI. Например, работа с СУБД через нативный обработчик – без проблем, HTTP-запросы – тоже без проблем. Например:
```Python
def run_request_task_native(hashMap,_files=None,_data=None):  
    hashMap.put("BreakHandlersIfError","")  
    
    workercode=[{"action":"run","type":"http","method":"GET #long1c/get_goods"},
			    {"action":"run","type":"set","method":"SQLParameter=@ResultMessage"},
			    {"action":"run","type":"sql","method":"insert into goods(art,barcode,nom) values(?,?,?)"},
			    {"action":"run","type":"set","method":"speak=Данные загружены"}]		    
          
    hashMap.put("StartWork",json.dumps({"work": workercode, "tag": "my_single_task", "retry": True, "conditions":"BATTERY_NOT_LOW;CHARGING;CONNECTED"}, ensure_ascii=False))  
		      
    return hashMap
```
Обработчик отработает и после перезагрузки устройства